---
layout: pt
---




# ìœ í•œ ìƒíƒœ ê¸°ê³„


![state-machine](https://refactoring.guru/images/patterns/diagrams/state/problem1.png?id%3D503968745461a0970d1fbb4362dc186f)


### í•˜ë‚˜ì˜ ê°ì²´ê°€ ìƒëª… ì£¼ê¸° ë™ì•ˆ ê°€ì§ˆ ìˆ˜ ìˆëŠ” ìƒíƒœì˜ ë³€í™”




---




## ì‹œì‘ ìƒíƒœì™€ ì¢…ë£Œ ìƒíƒœ

```mermaid
stateDiagram-v2
direction LR

[*] --> [*]
```


---


## ìƒíƒœ

```mermaid
stateDiagram-v2

state "State 1" as state1
state "State 2" as state2
state "State 3" as state3
```



---



## ì „ì´

```mermaid
stateDiagram-v2
direction LR

state "State 1" as state1
state "State 2" as state2
state "State 3" as state3
state "State 4" as state4

state1 --> state2
state2 --> state3 : í–‰ë™
state3 --> state4 : í–‰ë™[ì¡°ê±´]
```



---



## ì„ íƒ

```mermaid
stateDiagram-v2
direction LR

state "State 1" as state1
state "State 2" as state2
state "State 3" as state3
state "State 4" as state4
state if <<choice>>

state1 --> state2
state2 --> if : í–‰ë™
if --> state3 : ì¡°ê±´ 1
if --> state4 : ì¡°ê±´ 2
```




---




```mermaid
stateDiagram-v2

state "ì‘ì„± ì™„ë£Œ" as written
state "ë°œì†¡ ì˜ˆì•½" as reserved
state "ë°œì†¡ ì™„ë£Œ" as sent
state "ê²°ì œ ì™„ë£Œ" as payed
state "ê²°ì œ ì·¨ì†Œ ì™„ë£Œ" as paymentCanceled
state "íŒŒê¸° ì™„ë£Œ" as destroyed

state ifSendReservation <<choice>>


[*] --> written : ì‘ì„±í•˜ê¸°
written --> sent : ë°œì†¡í•˜ê¸°
written --> reserved : ë°œì†¡ ì˜ˆì•½í•˜ê¸°

reserved --> ifSendReservation : ë°œì†¡í•˜ê¸°
ifSendReservation --> sent : ë°œì†¡ ê°€ëŠ¥ (ë°œì†¡ ì˜ˆì • ì‹œê° â‰¥ í˜„ì¬ ì‹œê°)
ifSendReservation --> reserved : ë°œì†¡ ë¶ˆê°€ëŠ¥ (ë°œì†¡ ì˜ˆì • ì‹œê° < í˜„ì¬ ì‹œê°)

sent --> payed : ê²°ì œí•˜ê¸°
payed --> paymentCanceled : ê²°ì œ ì·¨ì†Œí•˜ê¸°

sent --> destroyed : íŒŒê¸°í•˜ê¸°
reserved --> destroyed : íŒŒê¸°í•˜ê¸°

paymentCanceled --> [*]
destroyed --> [*]
```




---



# ìƒíƒœ ê¸°ê³„ ì‘ì„± ì£¼ì˜ ì‚¬í•­


## 'í•˜ë‚˜'ì˜ ê°ì²´ì— ëŒ€í•œ ìƒíƒœ


## ë¸”ë™í™€ ìƒíƒœ ì£¼ì˜í•˜ê¸°







---
---









# State Pattern



## ê°ì²´ì˜ ìƒíƒœì— ë”°ë¼ í–‰ë™ ë°”ê¾¸ê¸°


![state-pattern](https://refactoring.guru/images/patterns/content/state/state-ko.png?id%3Dd0ebc2efe76959288257a989faebb978)






---



## ìƒíƒœ : íŠ¹ì • ì‹œì ì— ê°€ì§ˆ ìˆ˜ ìˆëŠ” ëª¨ë“  ê°€ëŠ¥í•œ ì¡°ê±´ì´ë‚˜ ìƒí™©


### ë³€ìˆ˜ì˜ ê°’

### ê°ì²´ì˜ ì†ì„±

### ì‹œìŠ¤í…œ ì„¤ì •





---



## State Patternì˜ 'ìƒíƒœ'

#### ê°ì²´ì˜ í–‰ë™ì„ ê²°ì •í•˜ëŠ” ë‚´ë¶€ ì¡°ê±´ì´ë‚˜ êµ¬ì„±

- ìƒíƒœëŠ” ê°ì²´ê°€ ê°€ì§„ ì •ë³´(data)ì™€ ê·¸ ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•(í–‰ìœ„)ì— ì˜í•´ ê²°ì •ë¨

```mermaid
flowchart

    subgraph ê°ì²´ ìƒëª… ì£¼ê¸°
    direction LR

    state(ìƒíƒœ)
    method(í–‰ë™)

    state -->|ìƒíƒœì— ë”°ë¼ í–‰ë™ì´ ê²°ì •ë¨| method
    method -->|í–‰ë™ì„ ìˆ˜í–‰í•˜ë©´ ìƒíƒœê°€ ë³€ê²½ë¨| state
end
```




---




## State Pattern êµ¬í˜„

```java
class Context {
    State state;

    void setState(State state) {
        this.state = state;
    }

    void request() {
        state.handle(this);    // state ê°ì²´ì— ì²˜ë¦¬ë¥¼ ìœ„ì„í•¨
    }
}
```

```java
interface State {
    void handle(Context context);
}

class ConcreteStateA implements State {
    @Override
    public void handle(Context context) {
        // ...
    }
}

class ConcreteStateB implements State {
    @Override
    public void handle(Context context) {
        // ...
        context.setState(ConcreteStateC.getInstance());    // ìƒíƒœì—ì„œ ë™ì‘ì„ ì‹¤í–‰í•œ í›„ ë°”ë¡œ ë‹¤ë¥¸ ìƒíƒœë¡œ ë°”ê¾¸ê¸°ë„ í•¨
    }
}

class ConcreteStateC implements State {
    @Override
    public void handle(Context context) {
        // ...
    }
}
```

```mermaid
classDiagram

class Client

class Context {
    -state: State

    +Context(State)

    +request()
    +setState(State)
}

class State {
    <<interface>>
    +handle()
}

class ConcreteStateA {
    +handle()
}

class ConcreteStateB {
    +handle()
}

Client --> Context

Context --* State
State <|.. ConcreteStateA
State <|.. ConcreteStateB
```





---




## State Pattern ì‚¬ìš© íë¦„

```java
class Client {
    public static void main(String[] args) {
        Context context = new Context();

        // 1. StateA ìƒíƒœ ì„¤ì •
        context.setState(new ConcreteStateA());

        // 2. í˜„ì¬ StateA ìƒíƒœì— ë§ëŠ” method ì‹¤í–‰
        context.request();

        // 3. StateB ìƒíƒœ ì„¤ì •
        context.setState(new ConcreteStateB());

        // 4. StateB ìƒíƒœì—ì„œ ë‹¤ì‹œ StateC ìƒíƒœë¡œ ë³€ê²½
        context.request();

        // 5. StateC ìƒíƒœì— ë§ëŠ” method ì‹¤í–‰
        context.request();
    }
}
```

```mermaid
sequenceDiagram

actor Client

Client ->> Context : setState(StateA)
activate Context

Client ->> Context : request()
Context ->> StateA : handle()
activate StateA
StateA -->> Context : return
deactivate StateA

Client ->> Context : setState(StateB)
Client ->> Context : request()
Context ->> StateB : handle()
activate StateB
StateB ->> Context : setStat(StateC)
StateB -->> Context : return
deactivate StateB

Client ->> Context : request()
Context ->> StateC : handle()
activate StateC
StateC -->> Context : return
deactivate StateC

deactivate Context
```



---




## ë¹„ìŠ·í•˜ì§€ë§Œ ë‹¤ë¥¸ Strategy Patternê³¼ State Pattern

| Strategy Pattern | State Pattern |
| --- | --- |
| **í–‰ë™**ì„ ê°ì²´í™” | **ìƒíƒœ**ë¥¼ ê°ì²´í™” |
| **Context ê°ì²´ê°€ í–‰ë™ì„ ê²°ì •** | **State ê°ì²´ê°€ í–‰ë™ì„ ê²°ì •** |
| ì „ëµ ê°ì²´ëŠ” **ê·¸ ì „ëµë§Œì˜ ì•Œê³ ë¦¬ì¦˜ ë™ì‘ì„ ì •ì˜ ë° ìˆ˜í–‰**í•¨ | ìƒíƒœ ê°ì²´ëŠ” ìƒíƒœê°€ ì ìš©ë˜ëŠ” **ëŒ€ìƒ ê°ì²´ê°€ í•  ìˆ˜ ìˆëŠ” ëª¨ë“  í–‰ë™ë“¤ì„ ì •ì˜ ë° ìˆ˜í–‰ |




---




## Example : ë½‘ê¸° ê¸°ê³„

- ë™ì „ì„ ë„£ê³  ì†ì¡ì´ë¥¼ ëŒë¦¬ë©´ ì•Œë§¹ì´ê°€ 1ê°œ ë‚˜ì˜¤ëŠ” ê¸°ê³„
- 10% í™•ë¥ ë¡œ ë‹¹ì²¨ë˜ë©´ ì•Œë§¹ì´ë¥¼ 2ê°œ ë°›ìŒ

```mermaid
stateDiagram-v2

state "ë™ì „ ì—†ìŒ" as noQuarter
state "ë™ì „ ìˆìŒ" as hasQuarter
state "ì•Œë§¹ì´ íŒë§¤" as sold
state "ì•Œë§¹ì´ ë§¤ì§„" as soldOut
state "ë‹¹ì²¨" as winner

state ifSold <<choice>>
state ifWinner <<choice>>
state ifSoldOut <<choice>>
state ifHasQuarter <<choice>>


[*] --> noQuarter

noQuarter --> hasQuarter : ë™ì „ íˆ¬ì…

hasQuarter --> noQuarter : ë™ì „ ë°˜í™˜
hasQuarter --> ifHasQuarter : ì†ì¡ì´ ëŒë¦¼
ifHasQuarter --> sold : ë‹¹ì²¨ë˜ì§€ ì•ŠìŒ
ifHasQuarter --> winner : ë‹¹ì²¨ë¨

sold --> ifSold : ì•Œë§¹ì´ ë‚´ë³´ëƒ„
ifSold --> noQuarter : ì•Œë§¹ì´ > 0
ifSold --> soldOut : ì•Œë§¹ì´ = 0

winner --> ifWinner : ì•Œë§¹ì´ ë‘ ê°œ ë‚´ë³´ëƒ„
ifWinner --> noQuarter : ì•Œë§¹ì´ > 0
ifWinner --> soldOut : ì•Œë§¹ì´ = 0

soldOut --> ifSoldOut : ì•Œë§¹ì´ ì¶©ì „
ifSoldOut --> noQuarter : ì—¬ë¶„ ìˆìŒ
ifSoldOut --> [*] : ì—¬ë¶„ ì—†ìŒ
```

```mermaid
classDiagram

class GumballMachine {
    int count
    State state
    insertQuarter()
    ejectQuarter()
    turnCrank()
    dispense()
    refill()
}

class State {
    <<Interfcae>>
    insertQuarter()
    ejectQuarter()
    turnCrank()
    dispense()
    refill()
}

class SoldState {
    GumballMachine gumballMachine
    insertQuarter()
    ejectQuarter()
    turnCrank()
    dispense()
    refill()
}

class SoldOutState {
    GumballMachine gumballMachine
    insertQuarter()
    ejectQuarter()
    turnCrank()
    dispense()
    refill()
}

class NoQuarterState {
    GumballMachine gumballMachine
    insertQuarter()
    ejectQuarter()
    turnCrank()
    dispense()
    refill()
}

class HasQuarterState {
    GumballMachine gumballMachine
    insertQuarter()
    ejectQuarter()
    turnCrank()
    dispense()
    refill()
}

class WinnerState {
    GumballMachine gumballMachine
    insertQuarter()
    ejectQuarter()
    turnCrank()
    dispense()
    refill()
}


GumballMachine --* State

State <|.. SoldState
State <|.. SoldOutState
State <|.. NoQuarterState
State <|.. HasQuarterState
State <|.. WinnerState


note for State "ëª¨ë“  ìƒíƒœ classì—ì„œ ì‚¬ìš©í•˜ëŠ” interfaceì…ë‹ˆë‹¤.\nmethodëŠ” ë½‘ê¸° ê¸°ê³„ì—ì„œ ì¼ì–´ë‚  ìˆ˜ ìˆëŠ” ëª¨ë“  í–‰ë™ë“¤ì— ì§ì ‘ì ìœ¼ë¡œ ëŒ€ì‘ë©ë‹ˆë‹¤."
```


### Test Code

```java
public class GumballMachineTestDrive {
    public static void main(String[] args) {
        GumballMachine gumballMachine = new GumballMachine(10);

        System.out.println(gumballMachine);

        gumballMachine.insertQuarter();
        gumballMachine.turnCrank();
        gumballMachine.insertQuarter();
        gumballMachine.turnCrank();

        System.out.println(gumballMachine);

        gumballMachine.insertQuarter();
        gumballMachine.turnCrank();
        gumballMachine.insertQuarter();
        gumballMachine.turnCrank();

        System.out.println(gumballMachine);

        gumballMachine.insertQuarter();
        gumballMachine.turnCrank();
        gumballMachine.insertQuarter();
        gumballMachine.turnCrank();

        System.out.println(gumballMachine);

        gumballMachine.insertQuarter();
        gumballMachine.turnCrank();
        gumballMachine.insertQuarter();
        gumballMachine.turnCrank();

        System.out.println(gumballMachine);

        gumballMachine.insertQuarter();
        gumballMachine.turnCrank();
        gumballMachine.insertQuarter();
        gumballMachine.turnCrank();

        System.out.println(gumballMachine);
    }
}
```


### Context

```java
public class GumballMachine {
 
    State soldOutState;
    State noQuarterState;
    State hasQuarterState;
    State soldState;
    State winnerState;
 
    State state = soldOutState;
    int count = 0;
 
    public GumballMachine(int numberGumballs) {
        soldOutState = new SoldOutState(this);
        noQuarterState = new NoQuarterState(this);
        hasQuarterState = new HasQuarterState(this);
        soldState = new SoldState(this);
        winnerState = new WinnerState(this);

        this.count = numberGumballs;
         if (numberGumballs > 0) {
            state = noQuarterState;
        } 
    }
 
    public void insertQuarter() {
        state.insertQuarter();
    }
 
    public void ejectQuarter() {
        state.ejectQuarter();
    }
 
    public void turnCrank() {
        state.turnCrank();
        state.dispense();
    }

    void setState(State state) {
        this.state = state;
    }
 
    void releaseBall() {
        System.out.println("A gumball comes rolling out the slot...");
        if (count > 0) {
            count = count - 1;
        }
    }
 
    int getCount() {
        return count;
    }
 
    void refill(int count) {
        this.count += count;
        System.out.println("The gumball machine was just refilled; its new count is: " + this.count);
        state.refill();
    }

    public State getState() {
        return state;
    }

    public State getSoldOutState() {
        return soldOutState;
    }

    public State getNoQuarterState() {
        return noQuarterState;
    }

    public State getHasQuarterState() {
        return hasQuarterState;
    }

    public State getSoldState() {
        return soldState;
    }

    public State getWinnerState() {
        return winnerState;
    }
 
    public String toString() {
        StringBuffer result = new StringBuffer();
        result.append("\nMighty Gumball, Inc.");
        result.append("\nJava-enabled Standing Gumball Model #2004");
        result.append("\nInventory: " + count + " gumball");
        if (count != 1) {
            result.append("s");
        }
        result.append("\n");
        result.append("Machine is " + state + "\n");
        return result.toString();
    }
}
```


### State

```java
public interface State {
 
    public void insertQuarter();
    public void ejectQuarter();
    public void turnCrank();
    public void dispense();
    
    public void refill();
}
```

```java
public class SoldState implements State {
    GumballMachine gumballMachine;
 
    public SoldState(GumballMachine gumballMachine) {
        this.gumballMachine = gumballMachine;
    }
       
    public void insertQuarter() {
        System.out.println("Please wait, we're already giving you a gumball");
    }
 
    public void ejectQuarter() {
        System.out.println("Sorry, you already turned the crank");
    }
 
    public void turnCrank() {
        System.out.println("Turning twice doesn't get you another gumball!");
    }
 
    public void dispense() {
        gumballMachine.releaseBall();
        if (gumballMachine.getCount() > 0) {
            gumballMachine.setState(gumballMachine.getNoQuarterState());
        } else {
            System.out.println("Oops, out of gumballs!");
            gumballMachine.setState(gumballMachine.getSoldOutState());
        }
    }
    
    public void refill() { }
 
    public String toString() {
        return "dispensing a gumball";
    }
}
```

```java
public class SoldOutState implements State {
    GumballMachine gumballMachine;
 
    public SoldOutState(GumballMachine gumballMachine) {
        this.gumballMachine = gumballMachine;
    }
 
    public void insertQuarter() {
        System.out.println("You can't insert a quarter, the machine is sold out");
    }
 
    public void ejectQuarter() {
        System.out.println("You can't eject, you haven't inserted a quarter yet");
    }
 
    public void turnCrank() {
        System.out.println("You turned, but there are no gumballs");
    }
 
    public void dispense() {
        System.out.println("No gumball dispensed");
    }
    
    public void refill() { 
        gumballMachine.setState(gumballMachine.getNoQuarterState());
    }
 
    public String toString() {
        return "sold out";
    }
}
```

```java
import java.util.Random;

public class HasQuarterState implements State {
    Random randomWinner = new Random(System.currentTimeMillis());
    GumballMachine gumballMachine;
 
    public HasQuarterState(GumballMachine gumballMachine) {
        this.gumballMachine = gumballMachine;
    }
  
    public void insertQuarter() {
        System.out.println("You can't insert another quarter");
    }
 
    public void ejectQuarter() {
        System.out.println("Quarter returned");
        gumballMachine.setState(gumballMachine.getNoQuarterState());
    }
 
    public void turnCrank() {
        System.out.println("You turned...");
        int winner = randomWinner.nextInt(10);
        if ((winner == 0) && (gumballMachine.getCount() > 1)) {
            gumballMachine.setState(gumballMachine.getWinnerState());
        } else {
            gumballMachine.setState(gumballMachine.getSoldState());
        }
    }

    public void dispense() {
        System.out.println("No gumball dispensed");
    }
    
    public void refill() { }
 
    public String toString() {
        return "waiting for turn of crank";
    }
}
```

```java
public class NoQuarterState implements State {
    GumballMachine gumballMachine;
 
    public NoQuarterState(GumballMachine gumballMachine) {
        this.gumballMachine = gumballMachine;
    }
 
    public void insertQuarter() {
        System.out.println("You inserted a quarter");
        gumballMachine.setState(gumballMachine.getHasQuarterState());
    }
 
    public void ejectQuarter() {
        System.out.println("You haven't inserted a quarter");
    }
 
    public void turnCrank() {
        System.out.println("You turned, but there's no quarter");
     }
 
    public void dispense() {
        System.out.println("You need to pay first");
    } 
    
    public void refill() { }
 
    public String toString() {
        return "waiting for quarter";
    }
}
```

```java
public class WinnerState implements State {
    GumballMachine gumballMachine;
 
    public WinnerState(GumballMachine gumballMachine) {
        this.gumballMachine = gumballMachine;
    }
 
    public void insertQuarter() {
        System.out.println("Please wait, we're already giving you a Gumball");
    }
 
    public void ejectQuarter() {
        System.out.println("Please wait, we're already giving you a Gumball");
    }
 
    public void turnCrank() {
        System.out.println("Turning again doesn't get you another gumball!");
    }
 
    public void dispense() {
        gumballMachine.releaseBall();
        if (gumballMachine.getCount() == 0) {
            gumballMachine.setState(gumballMachine.getSoldOutState());
        } else {
            gumballMachine.releaseBall();
            System.out.println("YOU'RE A WINNER! You got two gumballs for your quarter");
            if (gumballMachine.getCount() > 0) {
                gumballMachine.setState(gumballMachine.getNoQuarterState());
            } else {
                System.out.println("Oops, out of gumballs!");
                gumballMachine.setState(gumballMachine.getSoldOutState());
            }
        }
    }
 
    public void refill() { }
    
    public String toString() {
        return "despensing two gumballs for your quarter, because YOU'RE A WINNER!";
    }
}
```

### Context without State Pattern

```java
public class GumballMachine {
 
    final static int SOLD_OUT = 0;
    final static int NO_QUARTER = 1;
    final static int HAS_QUARTER = 2;
    final static int SOLD = 3;
 
    int state = SOLD_OUT;
    int count = 0;
  
    public GumballMachine(int count) {
        this.count = count;
        if (count > 0) {
            state = NO_QUARTER;
        }
    }
  
    public void insertQuarter() {
        if (state == HAS_QUARTER) {
            System.out.println("You can't insert another quarter");
        } else if (state == NO_QUARTER) {
            state = HAS_QUARTER;
            System.out.println("You inserted a quarter");
        } else if (state == SOLD_OUT) {
            System.out.println("You can't insert a quarter, the machine is sold out");
        } else if (state == SOLD) {
            System.out.println("Please wait, we're already giving you a gumball");
        }
    }

    public void ejectQuarter() {
        if (state == HAS_QUARTER) {
            System.out.println("Quarter returned");
            state = NO_QUARTER;
        } else if (state == NO_QUARTER) {
            System.out.println("You haven't inserted a quarter");
        } else if (state == SOLD) {
            System.out.println("Sorry, you already turned the crank");
        } else if (state == SOLD_OUT) {
            System.out.println("You can't eject, you haven't inserted a quarter yet");
        }
    }
 
    public void turnCrank() {
        if (state == SOLD) {
            System.out.println("Turning twice doesn't get you another gumball!");
        } else if (state == NO_QUARTER) {
            System.out.println("You turned but there's no quarter");
        } else if (state == SOLD_OUT) {
            System.out.println("You turned, but there are no gumballs");
        } else if (state == HAS_QUARTER) {
            System.out.println("You turned...");
            state = SOLD;
            dispense();
        }
    }
 
    private void dispense() {
        if (state == SOLD) {
            System.out.println("A gumball comes rolling out the slot");
            count = count - 1;
            if (count == 0) {
                System.out.println("Oops, out of gumballs!");
                state = SOLD_OUT;
            } else {
                state = NO_QUARTER;
            }
        } else if (state == NO_QUARTER) {
            System.out.println("You need to pay first");
        } else if (state == SOLD_OUT) {
            System.out.println("No gumball dispensed");
        } else if (state == HAS_QUARTER) {
            System.out.println("No gumball dispensed");
        }
    }
 
    public void refill(int numGumBalls) {
        this.count = numGumBalls;
        state = NO_QUARTER;
    }

    public String toString() {
        StringBuffer result = new StringBuffer();
        result.append("\nMighty Gumball, Inc.");
        result.append("\nJava-enabled Standing Gumball Model #2004\n");
        result.append("Inventory: " + count + " gumball");
        if (count != 1) {
            result.append("s");
        }
        result.append("\nMachine is ");
        if (state == SOLD_OUT) {
            result.append("sold out");
        } else if (state == NO_QUARTER) {
            result.append("waiting for quarter");
        } else if (state == HAS_QUARTER) {
            result.append("waiting for turn of crank");
        } else if (state == SOLD) {
            result.append("delivering a gumball");
        }
        result.append("\n");
        return result.toString();
    }
}
```



---
---
---
---
---






# Reference

- Head First Design Patterns (ë„ì„œ) - Eric Freeman, Elisabeth Robson, Bert Bates, Kathy Sierra
- <https://inpa.tistory.com/entry/GOF-ğŸ’ -ìƒíƒœState-pattern-ì œëŒ€ë¡œ-ë°°ì›Œë³´ì>
- <https://refactoring.guru/ko/design-patterns/state>



